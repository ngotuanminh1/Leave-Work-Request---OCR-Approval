<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Chi tiết đơn ID {{ don_id }}</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/don_detail.css') }}">

  <style>
    /* CSS cho các badge trạng thái */
    .badge-waiting {
      background-color: #ffc107;
      color: #333;
    }

    .badge-success {
      background-color: #28a745;
      color: white;
    }

    .badge-danger {
      background-color: #dc3545;
      color: white;
    }

    .badge {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 700;
    }

    .detail-card {
      max-width: 800px;
      margin: 30px auto;
      padding: 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background-color: #fff;
    }

    .ocr-section {
      margin-top: 30px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }

    pre {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      /* Quan trọng cho văn bản OCR dài */
    }
  </style>
</head>
<div class="mt-4">
  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">← Trở về dashboard</a>
</div>

<body class="bg-light">
  <div class="detail-card">
    <h1 class="mb-4 text-primary">Chi tiết đơn ID {{ don_id }}</h1>
    <hr>

    <div class="row">
      <div class="col-md-6">
        <p><strong>Họ tên:</strong> {{ don.ho_ten or 'Chưa có' }}</p>
        <p><strong>Mã NV:</strong> {{ don.ma_nv or 'Chưa có' }}</p>
        <p><strong>Phòng ban:</strong> {{ don.phong_ban or 'Chưa có' }}</p>
        <p><strong>Loại đơn:</strong> {{ don.loai_don or 'Chưa có' }}</p>
        <p><strong>Lý do:</strong> {{ don.ly_do or 'Chưa có' }}</p>
      </div>
      <div class="col-md-6">
        <p><strong>Ngày gửi:</strong> {{ don.ngay_gui or 'N/A' }}</p>
        <p><strong>Ngày bắt đầu:</strong> {{ don.ngay_bat_dau or 'Chưa có' }}</p>
        <p><strong>Ngày kết thúc:</strong> {{ don.ngay_ket_thuc or 'Chưa có' }}</p>

        <p><strong>Trạng thái:</strong>
          {% set status = don.trang_thai|lower %}
          {% if 'chờ duyệt' in status %}
          <span class="badge badge-warning">Chờ duyệt</span>
          {% elif 'đã duyệt' in status or 'hoàn tất' in status %}
          <span class="badge badge-success">Đã duyệt</span>
          {% elif 'từ chối' in status %}
          <span class="badge badge-danger">Từ chối</span>
          {% else %}
          <span class="badge badge-info">{{ don.trang_thai or 'Chưa có' }}</span>
          {% endif %}
        </p>
        {% if 'từ chối' in status and ly_do_tu_choi_log %}
        <div class="alert alert-danger p-3 mt-3" role="alert">
          <h6 class="alert-heading font-weight-bold mb-1">
            ❌ Đơn đã bị TỪ CHỐI
          </h6>

          <p class="mb-0 small">
            {{ ly_do_tu_choi_log.ghi_chu }}
          </p>
          <footer class="blockquote-footer text-right mt-1 small">
            Thời gian: {{ ly_do_tu_choi_log.thoi_gian }}
          </footer>
        </div>
        {% endif %}

        {% if 'chờ duyệt' in status %}
        <p class="mt-3">
          <strong>Đang chờ duyệt bởi:</strong>
          {% set approver = don.nguoi_duyet_hien_tai|lower|trim %}

          {% if approver.startswith('quan_ly_cua_') %}
          {% set parts = approver.split('_cua_') %}
          {% set phong_name = parts[1].replace('_', ' ')|title if parts|length > 1 else 'Quản lý cấp 1' %}
          <span class="text-danger font-weight-bold">Quản lý {{ phong_name }}</span>

          {% elif approver == 'nhan_su' %}
          <span class="text-danger font-weight-bold">Phòng Nhân sự</span>

          {% elif approver == 'ke_toan' %}
          <span class="text-danger font-weight-bold">Phòng Kế toán</span>

          {% elif approver == 'giam_doc' %}
          <span class="text-danger font-weight-bold">Ban Giám đốc</span>

          {% else %}
          <span class="text-muted">Đang chờ xử lý luồng</span>
          {% endif %}
        </p>
        {% endif %}
      </div>
    </div>

    <div class="ocr-section">
      <h3 class="mb-3 text-secondary">Dữ liệu nguồn (Ảnh/OCR)</h3>

      {% if don.file_goc %}
      <p><strong>File gốc:</strong></p>
      <img src="{{ url_for('uploaded_file', filename=don.file_goc) }}" class="img-fluid border mb-4"
        style="max-width: 100%; height: auto;" />
      {% endif %}

      <p><strong>Kết quả OCR gốc:</strong></p>
      <pre>{{ don.ket_qua_ocr or 'Không có dữ liệu OCR' }}</pre>
    </div>
  </div>
</body>

</html>